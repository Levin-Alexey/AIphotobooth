# 🎯 ОТЧЕТ: Система приема платежей для AI Photobooth

## ✅ ЧТО БЫЛО СДЕЛАНО

Создана полная архитектура системы приема платежей от Юкассы с интеграцией в D1 базу данных и Telegram бота.

---

## 📁 СТРУКТУРА ФАЙЛОВ

```
handlers/
├── payments/
│   ├── paymentCallback.js      # Webhook обработчик от Юкассы
│   └── initiatePayment.js      # Инициирование платежа
│
services/
├── yookassa.js                 # API клиент Юкассы
└── order.js                    # Сервисы для работы с заказами/платежами
```

---

## 🔧 КОМПОНЕНТЫ

### 1️⃣ **services/yookassa.js**
Сервис для работы с API Юкассы:

- `YookassaService` - класс для создания платежей и получения их статуса
  - `createPayment()` - создает платеж в Юкассе
  - `getPayment()` - получает информацию о платеже  
  - `validateWebhookSignature()` - валидирует webhook

- `getPaymentDetails()` - функция для получения цены и описания по типу услуги

**Текущие цены:**
- Фотосессии (7 типов): 999 ₽
- Готовое фото: 499 ₽
- Генерация по промпту: 1499 ₽

### 2️⃣ **services/order.js**
Два сервиса для работы с БД:

- `OrderService` - управление заказами
  - `createOrder()` - создает заказ в статусе 'pending'
  - `markOrderAsPaid()` - переводит в 'paid' после оплаты
  - `markOrderAsProcessing()` - переводит в 'processing' при обработке
  - `markOrderAsCompleted()` - переводит в 'completed' с результатом
  - `getOrder()` - получает заказ по ID
  - `getUserOrders()` - получает все заказы пользователя

- `PaymentService` - логирование платежей
  - `recordPayment()` - сохраняет платеж в БД
  - `getPayment()` - получает платеж по ID
  - `getPaymentByOrderId()` - получает платеж по заказу

### 3️⃣ **handlers/payments/paymentCallback.js**
Webhook обработчик от Юкассы (URL: `https://pay.ai-mommy.ru/payment-callback`):

**Что делает:**
1. Получает уведомление от Юкассы о статусе платежа
2. Парсит метаданные (telegramId, chatId, orderId, packId)
3. Записывает платеж в Payments таблицу
4. Обновляет заказ на статус 'paid'
5. Отправляет подтверждение пользователю в Telegram
6. Ставит заказ в очередь (Queue) на обработку

**Обрабатываемые события:**
- `payment.succeeded` - успешная оплата
- `payment.canceled` - отмена оплаты

### 4️⃣ **handlers/payments/initiatePayment.js**
Функция для инициирования платежа:

**Процесс:**
1. Валидирует входные параметры
2. Получает детали платежа (сумма, описание)
3. Создает заказ в D1 (статус 'pending')
4. Создает платеж в Юкассе через API
5. Отправляет пользователю ссылку для оплаты в Telegram

```javascript
// Использование:
await initiatePayment(
  env,              // Окружение (DB, токены)
  telegramId,       // ID пользователя в Telegram
  chatId,           // ID чата
  'session_pregnancy', // Тип услуги
  botToken          // Токен бота
);
```

---

## 📊 ПОТОК ДАННЫХ

```
┌─────────────────────────────────────────────────────────────┐
│ 1. Пользователь выбирает сессию в боте                      │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. Вызывается initiatePayment()                             │
│    - Создается заказ в Orders (статус 'pending')           │
│    - Создается платеж в Юкассе                             │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. Пользователю отправляется ссылка для оплаты             │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. Пользователь оплачивает в Юкассе                         │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. Юкасса отправляет webhook на /payment-callback           │
│    (Это вызывает paymentCallback handler)                   │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│ 6. paymentCallback.js:                                      │
│    - Проверяет что платеж успешен                          │
│    - Записывает в Payments таблицу                         │
│    - Обновляет Orders на статус 'paid'                     │
│    - Отправляет уведомление в Telegram                     │
│    - Ставит в Queue на обработку                           │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│ 7. Consumer обработает заказ из Queue:                      │
│    - Обновит статус на 'processing'                        │
│    - Будет генерировать/обрабатывать фото                  │
│    - Обновит статус на 'completed' с результатом           │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔐 ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ (нужно добавить в wrangler.toml)

```toml
[env.production.vars]
YOOKASSA_SHOP_ID = "ваш_shop_id_от_юкассы"
YOOKASSA_SECRET_KEY = "ваш_secret_key_от_юкассы"
```

---

## 📝 ИНТЕГРАЦИЯ В index.js

Нужно обновить основной файл так:

```javascript
// В начале добавить импорт:
import { handlePaymentCallback } from './handlers/payments/paymentCallback.js';
import { initiatePayment } from './handlers/payments/initiatePayment.js';

// В fetch() обработчик платежей добавить:
if (url.pathname === '/payment-callback' && request.method === 'POST') {
  return await handlePaymentCallback(request, env, BOT_TOKEN);
}

// А когда пользователь нажимает на сессию, вызвать:
case 'session_pregnancy': {
  await initiatePayment(
    env,
    update.callback_query.from.id,  // telegramId
    chatId,
    'session_pregnancy',
    BOT_TOKEN
  );
  break;
}

// Аналогично для других сессий и услуг...
```

---

## 💾 БАЗА ДАННЫХ

Используются существующие таблицы:

### Orders
```sql
id                 - ID заказа (PRIMARY KEY)
telegram_id        - ID пользователя в Telegram
pack_id            - Тип услуги (session_pregnancy и т.д.)
status             - pending → paid → processing → completed
input_photos       - JSON с исходными фото
result_photos      - JSON с результатом
created_at         - Дата создания
updated_at         - Дата последнего обновления
```

### Payments
```sql
id                 - ID платежа (PRIMARY KEY)
order_id           - Ссылка на заказ
provider_payment_charge_id  - ID платежа в Юкассе
amount             - Сумма в копейках
currency           - Валюта (RUB по умолчанию)
created_at         - Дата платежа
```

### Users
```sql
telegram_id        - ID пользователя (PRIMARY KEY)
username           - Юзернейм Telegram
first_name         - Имя
created_at         - Дата регистрации
last_seen          - Последний вход
```

---

## ⚙️ КАК ЭТО РАБОТАЕТ

1. **Инициирование платежа** → `initiatePayment()` создает заказ 'pending' + платеж в Юкассе
2. **Редирект на оплату** → Пользователь нажимает кнопку и переходит на Юкассу
3. **Оплата** → Пользователь платит (тестовая карта: 5555555555554444)
4. **Webhook** → Юкасса отправляет уведомление на `/payment-callback`
5. **Обновление БД** → Заказ переходит в 'paid', платеж логируется
6. **Уведомление** → Пользователю отправляется подтверждение в Telegram
7. **Queue** → Заказ ставится в очередь на обработку

---

## 🚀 СЛЕДУЮЩИЕ ШАГИ

1. ✅ Добавить переменные YOOKASSA_SHOP_ID и YOOKASSA_SECRET_KEY в wrangler.toml
2. ✅ Обновить index.js с импортом и маршрутами для платежей
3. ⏭️ Прикрутить `initiatePayment()` к каждой кнопке сессии/услуги
4. ⏭️ Создать Consumer для Queue который обрабатывает заказы
5. ⏭️ Интегрировать AI/обработку фото в Consumer
6. ⏭️ Тестирование с тестовыми картами Юкассы

---

## 📋 ЧЕКЛИСТ ПОСЛЕ ЭТОГО

- [ ] Добавить YOOKASSA_SHOP_ID и YOOKASSA_SECRET_KEY в wrangler.toml
- [ ] Обновить index.js (импорты + route /payment-callback)
- [ ] Привязать initiatePayment к кнопкам сессий
- [ ] Привязать initiatePayment к "Сделать идеальное фото"
- [ ] Привязать initiatePayment к "Изменить по описанию"
- [ ] Протестировать с тестовой картой
- [ ] Создать обработчик для Queue
