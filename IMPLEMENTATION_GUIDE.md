# üí≥ –°–ò–°–¢–ï–ú–ê –ü–†–ò–ï–ú–ê –ü–õ–ê–¢–ï–ñ–ï–ô - –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –í–ù–ï–î–†–ï–ù–ò–Æ

## üìã –†–ï–ó–Æ–ú–ï

–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π –æ—Ç **–Æ–∫–∞—Å—Å—ã** —Å:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–∫–∞–∑–æ–≤ –≤ D1 –±–∞–∑–µ
- ‚úÖ Webhook –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–ª–∞—Ç–µ–∂–µ–π –æ—Ç –Æ–∫–∞—Å—Å—ã  
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å Telegram –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–æ–π –æ—á–µ—Ä–µ–¥–∏ (Queue) –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤
- ‚úÖ –ì–∏–±–∫–æ–π —Å–∏—Å—Ç–µ–º–æ–π —Ç–∏–ø–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π (—Å–µ—Å—Å–∏–∏, –≥–æ—Ç–æ–≤–æ–µ —Ñ–æ—Ç–æ, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)

---

## üîß –®–ê–ì–ò –í–ù–ï–î–†–ï–ù–ò–Ø

### –®–ê–ì 1: –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í [wrangler.toml](wrangler.toml) –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–µ–∫—Ü–∏—é `[vars]`:

```toml
[vars]
YOOKASSA_SHOP_ID = "687614"        # –ü–æ–ª—É—á–∏—Ç—å –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –Æ–∫–∞—Å—Å—ã
YOOKASSA_SECRET_KEY = "live_..."   # –ü–æ–ª—É—á–∏—Ç—å –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –Æ–∫–∞—Å—Å—ã
```

–ì–¥–µ –ø–æ–ª—É—á–∏—Ç—å:
1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ https://yookassa.ru/my/settings/api-credentials
2. –í —Ä–∞–∑–¥–µ–ª–µ "API" —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å "–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞" –∏ "–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á"

### –®–ê–ì 2: –û–±–Ω–æ–≤–∏—Ç—å index.js

–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏–∑ [INTEGRATION_EXAMPLE.js](INTEGRATION_EXAMPLE.js):

```javascript
// –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞:
import { handlePaymentCallback } from './handlers/payments/paymentCallback.js';
import { initiatePayment } from './handlers/payments/initiatePayment.js';

// –í fetch() –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π:
if (url.pathname === '/payment-callback' && request.method === 'POST') {
  return await handlePaymentCallback(request, env, BOT_TOKEN);
}

// –û–±–Ω–æ–≤–∏—Ç—å case –¥–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏ (–¥–æ–±–∞–≤–∏—Ç—å initiatePayment –≤–º–µ—Å—Ç–æ sendMessage)
case 'session_pregnancy': {
  await initiatePayment(env, telegramId, chatId, 'session_pregnancy', BOT_TOKEN);
  break;
}
// ... –∏ —Ç–∞–∫ –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö ...
```

### –®–ê–ì 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Webhook –≤ –Æ–∫–∞—Å—Å–µ

1. –ü–µ—Ä–µ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –Æ–∫–∞—Å—Å—ã
2. –ü–µ—Ä–µ–π—Ç–∏ –≤ "Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
3. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π URL: `https://pay.ai-mommy.ru/payment-callback`
4. –í—ã–±—Ä–∞—Ç—å —Å–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å

### –®–ê–ì 4: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π –Æ–∫–∞—Å—Å—ã:
- –ö–∞—Ä—Ç–∞: `5555 5555 5555 4444`
- CVC: –ª—é–±—ã–µ 3 —Ü–∏—Ñ—Ä—ã
- –î–∞—Ç–∞: –ª—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞

---

## üìÅ –°–û–ó–î–ê–ù–ù–´–ï –§–ê–ô–õ–´

```
services/
‚îú‚îÄ‚îÄ yookassa.js              # API –∫–ª–∏–µ–Ω—Ç –Æ–∫–∞—Å—Å—ã
‚îú‚îÄ‚îÄ order.js                 # –°–µ—Ä–≤–∏—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î (Orders, Payments)
‚îî‚îÄ‚îÄ queueConsumer.js         # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è Queue (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)

handlers/
‚îî‚îÄ‚îÄ payments/
    ‚îú‚îÄ‚îÄ paymentCallback.js   # Webhook –æ—Ç –Æ–∫–∞—Å—Å—ã (POST /payment-callback)
    ‚îî‚îÄ‚îÄ initiatePayment.js   # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
‚îú‚îÄ‚îÄ PAYMENT_SYSTEM_REPORT.md      # –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç —Å–∏—Å—Ç–µ–º—ã
‚îú‚îÄ‚îÄ INTEGRATION_EXAMPLE.js        # –ü—Ä–∏–º–µ—Ä—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ index.js
‚îî‚îÄ‚îÄ IMPLEMENTATION_GUIDE.md       # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

---

## üí∞ –¢–ï–ö–£–©–ò–ï –¶–ï–ù–´ (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –≤ getPaymentDetails)

| –£—Å–ª—É–≥–∞ | –¶–µ–Ω–∞ | –¢–∏–ø |
|--------|------|-----|
| 7 –§–æ—Ç–æ—Å–µ—Å—Å–∏–π | 999 ‚ÇΩ | session_pregnancy, session_newborn –∏ —Ç.–¥. |
| –ì–æ—Ç–æ–≤–æ–µ —Ñ–æ—Ç–æ | 499 ‚ÇΩ | ready_photo |
| –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–æ–º–ø—Ç—É | 1499 ‚ÇΩ | custom_edit |

–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å - –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ [services/yookassa.js](services/yookassa.js) —Ñ—É–Ω–∫—Ü–∏—é `getPaymentDetails()`.

---

## üîÑ –ü–û–¢–û–ö –û–ü–ï–†–ê–¶–ò–ô

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É —Å–µ—Å—Å–∏–∏
   ‚Üì
2. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è initiatePayment()
   ‚Üì
3. –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–∫–∞–∑ –≤ DB (—Å—Ç–∞—Ç—É—Å: pending)
   ‚Üì
4. –°–æ–∑–¥–∞–µ—Ç—Å—è –ø–ª–∞—Ç–µ–∂ –≤ –Æ–∫–∞—Å—Å–µ  
   ‚Üì
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã
   ‚Üì
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
   ‚Üì
7. –Æ–∫–∞—Å—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ /payment-callback
   ‚Üì
8. –ó–∞–∫–∞–∑ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (—Å—Ç–∞—Ç—É—Å: paid)
   ‚Üì
9. –ü–ª–∞—Ç–µ–∂ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –ë–î
   ‚Üì
10. –ó–∞–∫–∞–∑ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ Queue –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
   ‚Üì
11. Consumer –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–∫–∞–∑ (–±—É–¥—É—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
```

---

## üóÑÔ∏è –ë–ê–ó–ê –î–ê–ù–ù–´–•

### Orders —Ç–∞–±–ª–∏—Ü–∞
```sql
id              PRIMARY KEY - –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç
telegram_id     USER ID –≤ –¢–µ–ª–µ–≥—Ä–∞–º
pack_id         –¢–∏–ø —É—Å–ª—É–≥–∏ (session_pregnancy –∏ —Ç.–¥.)
status          pending | paid | processing | completed
input_photos    JSON {"urls": ["...", "..."]}
result_photos   JSON {"urls": ["...", "..."]}
created_at      Unix timestamp
updated_at      Unix timestamp
```

### Payments —Ç–∞–±–ª–∏—Ü–∞
```sql
id                          PRIMARY KEY - –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç
order_id                    –°—Å—ã–ª–∫–∞ –Ω–∞ Orders
provider_payment_charge_id  ID –ø–ª–∞—Ç–µ–∂–∞ –≤ –Æ–∫–∞—Å—Å–µ
amount                      –°—É–º–º–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)
currency                    RUB (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
created_at                  Unix timestamp
```

---

## üõ†Ô∏è –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò

### initiatePayment()
–°–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ –∏ –ø–ª–∞—Ç–µ–∂, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

```javascript
await initiatePayment(
  env,                    // –û–∫—Ä—É–∂–µ–Ω–∏–µ
  telegramId,            // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  chatId,                // ID —á–∞—Ç–∞
  'session_pregnancy',   // –¢–∏–ø —É—Å–ª—É–≥–∏
  BOT_TOKEN              // –¢–æ–∫–µ–Ω –±–æ—Ç–∞
);
```

### handlePaymentCallback()
Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω.

```javascript
if (url.pathname === '/payment-callback' && request.method === 'POST') {
  return await handlePaymentCallback(request, env, BOT_TOKEN);
}
```

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –ú–ï–¢–ê–î–ê–ù–ù–´–ï –ü–õ–ê–¢–ï–ñ–ê

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è:
```json
{
  "telegramId": 123456789,
  "chatId": 987654321,
  "orderId": 42,
  "packId": "session_pregnancy",
  "bot": "aiphotobooth"
}
```

–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏, –ø–æ—ç—Ç–æ–º—É —Å–∏—Å—Ç–µ–º–∞ –∑–Ω–∞–µ—Ç –∫–∞–∫–æ–π –∑–∞–∫–∞–∑ –æ–±–Ω–æ–≤–ª—è—Ç—å.

---

## üöÄ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï

```bash
# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞—Ç–∏–≤–Ω—ã–π fetch

# –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ Cloudflare
wrangler deploy

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
wrangler dev
```

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢

- [ ] –î–æ–±–∞–≤–∏—Ç—å YOOKASSA_SHOP_ID –∏ SECRET_KEY –≤ wrangler.toml
- [ ] –û–±–Ω–æ–≤–∏—Ç—å index.js (–∏–º–ø–æ—Ä—Ç—ã + route + case'—ã)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –Æ–∫–∞—Å—Å—ã
- [ ] –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ Cloudflare
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π `5555555555554444`
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ:
  - [ ] –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–∫–∞–∑ –≤ DB
  - [ ] –ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –Æ–∫–∞—Å—Å–µ
  - [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã
  - [ ] –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–∏—Ö–æ–¥–∏—Ç webhook
  - [ ] –ó–∞–∫–∞–∑ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Å—Ç–∞—Ç—É—Å 'paid'
  - [ ] –ü–ª–∞—Ç–µ–∂ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ DB
  - [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  - [ ] –ó–∞–∫–∞–∑ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ Queue

---

## üÜò –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú

**–ü—Ä–æ–±–ª–µ–º–∞:** Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–æ–º–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ webhookÊ∑ªÂä† –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –≤ –Æ–∫–∞—Å—Å–µ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Cloudflare Workers

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ –∑–∞–∫–∞–∑ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ env.DB –¥–æ—Å—Ç—É–ø–Ω–∞
- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ Orders —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ BOT_TOKEN –≤–µ—Ä–Ω—ã–π
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ chatId –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ sendMessage

---

## üìû –ü–û–î–î–ï–†–ñ–ö–ê

–®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ –Æ–∫–∞—Å—Å–µ:
- –¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞: https://yookassa.ru/developers/payment-acceptance/testing-and-going-live/testing
- API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://yookassa.ru/developers/api
- Webhook —Å–æ–±—ã—Ç–∏—è: https://yookassa.ru/developers/using-api/webhooks

---

## üéâ –í–°–ï –ì–û–¢–û–í–û!

–°–∏—Å—Ç–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.
–û—Å—Ç–∞—Ç–æ–∫: –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å AI –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–æ—Ç–æ –≤ queueConsumer.js
