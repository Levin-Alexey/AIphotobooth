/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ OpenRouter
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç gemini-3-pro-image-preview –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
 */

import { OrderService } from './order.js';

export async function processUniquePhoto(env, message) {
  const { orderId, telegramId, chatId, prompt, photoUrl } = message;
  
  try {
    console.log(`Processing unique photo for order ${orderId}`);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –µ—Å—Ç—å
    if (!env.OPENROUTER_API_KEY) {
      throw new Error('OPENROUTER_API_KEY is not configured. Please set it using: wrangler secret put OPENROUTER_API_KEY');
    }

    if (!env.BOT_TOKEN) {
      throw new Error('BOT_TOKEN is not configured');
    }

    const orderService = new OrderService(env.DB);
    
    // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ processing
    await orderService.markOrderAsProcessing(orderId);

    // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    await sendTelegramNotification(
      env.BOT_TOKEN,
      chatId,
      '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∞—à–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ...'
    );

    // 2.5. –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ –∏–∑ R2 –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64
    console.log(`Loading photo from R2: ${photoUrl}`);
    const r2Object = await env.BUCKET.get(photoUrl);
    if (!r2Object) {
      throw new Error(`Photo not found in R2: ${photoUrl}`);
    }
    
    const photoArrayBuffer = await r2Object.arrayBuffer();
    const photoBytes = new Uint8Array(photoArrayBuffer);
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 —á–µ—Ä–µ–∑ Web API
    let base64Photo = '';
    const binaryString = Array.from(photoBytes)
      .map(byte => String.fromCharCode(byte))
      .join('');
    base64Photo = btoa(binaryString);
    
    const photoDataUrl = `data:image/jpeg;base64,${base64Photo}`;
    console.log(`Photo converted to base64, length: ${base64Photo.length}`);

    // 3. –í—ã–∑—ã–≤–∞–µ–º OpenRouter API —Å —Ñ–æ—Ç–æ + –ø—Ä–æ–º–ø—Ç–æ–º
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${env.OPENROUTER_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'google/gemini-3-pro-image-preview',
        messages: [
          {
            role: 'user',
            content: [
              {
                type: 'text',
                text: prompt
              },
              {
                type: 'image_url',
                image_url: {
                  url: photoDataUrl
                }
              }
            ]
          }
        ],
        modalities: ['image', 'text']
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      const errorStatus = response.status;
      console.error(`OpenRouter API error (${errorStatus}):`, errorText);
      throw new Error(`OpenRouter API error (${errorStatus}): ${errorText}`);
    }

    const result = await response.json();
    console.log('OpenRouter response:', JSON.stringify(result, null, 2));

    // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Ç–≤–µ—Ç –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    if (!result.choices || !Array.isArray(result.choices) || result.choices.length === 0) {
      console.error('Invalid response structure from OpenRouter:', result);
      throw new Error('Invalid response structure from OpenRouter - no choices');
    }

    const choice = result.choices[0];
    if (!choice.message) {
      console.error('Invalid message in choice:', choice);
      throw new Error('Invalid response structure - no message in choice');
    }

    // –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞
    console.log('Message structure:', JSON.stringify({
      hasContent: !!choice.message.content,
      hasImages: !!choice.message.images,
      contentType: typeof choice.message.content,
      imagesType: typeof choice.message.images,
      messageKeys: Object.keys(choice.message)
    }));

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–µ
    if (!choice.message.images) {
      console.error('No images in response. Full message:', JSON.stringify(choice.message, null, 2));
      throw new Error('No images generated by OpenRouter - check model compatibility and credits');
    }

    const images = choice.message.images;
    if (!Array.isArray(images) || images.length === 0) {
      console.error('Images is not array or empty:', images);
      throw new Error('Images array is empty or invalid');
    }

    console.log(`Received ${images.length} images from OpenRouter`);
    const resultUrls = [];

    // 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ R2
    for (let i = 0; i < images.length; i++) {
      const image = images[i];
      
      console.log(`Processing image ${i + 1}:`, JSON.stringify(image).substring(0, 200));

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      if (!image.image_url || !image.image_url.url) {
        console.error(`Invalid image structure at index ${i}:`, image);
        throw new Error(`Invalid image structure at index ${i}`);
      }

      const imageUrl = image.image_url.url;
      
      let imageBuffer;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å–ª–∏ —ç—Ç–æ base64 data URL –∏–ª–∏ –æ–±—ã—á–Ω—ã–π URL
      if (imageUrl.startsWith('data:')) {
        // Base64 data URL - –¥–µ–∫–æ–¥–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ Web API (–±–µ–∑ Node.js Buffer)
        const base64Data = imageUrl.split(',')[1];
        if (!base64Data) {
          throw new Error(`Invalid base64 data URL at index ${i}`);
        }
        
        // –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64 –≤ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (Web API)
        const binaryString = atob(base64Data);
        const bytes = new Uint8Array(binaryString.length);
        for (let j = 0; j < binaryString.length; j++) {
          bytes[j] = binaryString.charCodeAt(j);
        }
        imageBuffer = bytes.buffer;
        
      } else if (imageUrl.startsWith('http')) {
        // –°–∫–∞—á–∏–≤–∞–µ–º —Å URL
        console.log(`Downloading image from URL: ${imageUrl.substring(0, 100)}...`);
        const imgResponse = await fetch(imageUrl);
        if (!imgResponse.ok) {
          throw new Error(`Failed to download image from URL: ${imgResponse.status}`);
        }
        imageBuffer = await imgResponse.arrayBuffer();
      } else {
        throw new Error(`Unknown image URL format at index ${i}: ${imageUrl.substring(0, 100)}`);
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ R2
      const r2Key = `output/${orderId}/result_${i + 1}_${Date.now()}.jpg`;
      await env.BUCKET.put(r2Key, imageBuffer, {
        httpMetadata: {
          contentType: 'image/jpeg'
        }
      });

      resultUrls.push(`r2://${r2Key}`);
      console.log(`Saved image ${i + 1} to R2: ${r2Key}`);
    }

    // 6. –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –Ω–∞ completed —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
    if (resultUrls.length === 0) {
      throw new Error('No result URLs were generated');
    }

    const resultData = { urls: resultUrls, generated_at: new Date().toISOString() };
    console.log(`Updating order ${orderId} with results:`, JSON.stringify(resultData));
    
    await orderService.markOrderAsCompleted(orderId, JSON.stringify(resultData));

    // 7. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Telegram
    for (let i = 0; i < resultUrls.length; i++) {
      const r2Path = resultUrls[i].replace('r2://', '');
      
      // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –∏–∑ R2
      const r2Object = await env.BUCKET.get(r2Path);
      if (!r2Object) {
        console.error(`Failed to get ${r2Path} from R2`);
        continue;
      }

      const arrayBuffer = await r2Object.arrayBuffer();
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –≤ Telegram
      await sendPhotoToTelegram(
        env.BOT_TOKEN,
        chatId,
        arrayBuffer,
        i === 0 ? `‚úÖ –í–∞—à–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ –≥–æ—Ç–æ–≤–æ!\n\nüìù –ü—Ä–æ–º–ø—Ç: ${prompt}` : null
      );
    }

    console.log(`Order ${orderId} completed successfully`);

  } catch (error) {
    console.error('Error processing unique photo:', error);
    
    // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± –æ—à–∏–±–∫–µ
    try {
      await sendTelegramNotification(
        env.BOT_TOKEN,
        chatId,
        `‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ.\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.\n\n–û—à–∏–±–∫–∞: ${error.message}`
      );
    } catch (e) {
      console.error('Could not send error notification:', e);
    }
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
 */
async function sendTelegramNotification(botToken, chatId, text) {
  const url = `https://api.telegram.org/bot${botToken}/sendMessage`;

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text: text,
        parse_mode: 'HTML'
      })
    });

    if (!response.ok) {
      const error = await response.json();
      console.error('Telegram error:', error);
    }
  } catch (error) {
    console.error('Error sending Telegram notification:', error);
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ –≤ Telegram
 */
async function sendPhotoToTelegram(botToken, chatId, photoBuffer, caption = null) {
  const url = `https://api.telegram.org/bot${botToken}/sendPhoto`;

  try {
    // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
    const formData = new FormData();
    formData.append('chat_id', chatId);
    formData.append('photo', new Blob([photoBuffer], { type: 'image/jpeg' }), 'photo.jpg');
    
    if (caption) {
      formData.append('caption', caption);
    }

    const response = await fetch(url, {
      method: 'POST',
      body: formData
    });

    if (!response.ok) {
      const error = await response.json();
      console.error('Telegram photo send error:', error);
    }
  } catch (error) {
    console.error('Error sending photo to Telegram:', error);
  }
}
